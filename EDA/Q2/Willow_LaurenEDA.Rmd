---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---



```{r}
library(dplyr)
library(ggplot2)
library(stringr)
library(tidytext)
library(gsubfn)
library(tidyr)
```

Read in the data set
```{r}
injuries <- read.csv("C:/Users/wduff/OneDrive/School/Harvard/Fall2021/BST260/BST_260_project/Data/injuries_only.csv")
```

```{r}
head(injuries)
dim(injuries)
```

```{r}
injuries <- injuries %>% mutate(injury_types = tolower(injury_types))
```

```{r}
# Replace any "/" with " " ?
injuries$injury_types <- gsub("/", " ", injuries$injury_types)
```


Body part vectors
```{r}
Head <- c("concussion", "head", "neck", "eye", "ear", "chin", "migranes", "migrane", "jaw", "nose", "tooth", "stinger", "faciallaceration", "eyelid", "facial", "mouth", "nose", "throat", "seizure")

Shoulder <- c("shoulder", "clavicle", "collarbone", "leftshoulder", "rightshoulder", "jointshoulder", "scapula", "sternoclavicular")

UpperTorso <- c("rib", "back", "pectoral", "pec", "chest", "oblique", "lumbar", "core", "spine", "trapezius", "kidney", "lung", "heart", "abdomen", "abdominal", "solarplexus", "spleen", "hernia", "arrhythmia", "liver", "stomach", "appendix")

LowerTorso <- c("glute", "buttocks", "hip", "righthip", "pelvis", "tailbone")


Arm <- c("arm", "rightupperarm", "forearm", "bicep", "biceps", "elbow", "rightelbow", "tricep", "triceps")

Hand <- c("hand", "righthand", "thumb", "rightthumb", "finger", "rightfinger", "wrist", "rightwrist")

Leg <- c("hamstring", "righthamstring", "knee", "rightknee", "acl", "mcl", "meniscus", "bothknees", "thigh", "rightthigh", "calf", "rightcalf", "quadricep", "rightquadricep", "quad", "groin", "rightgroin", "lowerleg", "tibia", "fibula", "shin", "rightshin", "adductor", "contusion")

Foot <- c("foot", "rightfoot", "ankle", "achilles", "toe", "toes", "heel")


```


Function to count broad body part injuries 
```{r}
# Bodypart input must be a string
broad <- function(bodylist, bodypart) {
  
  pasted <- paste(bodylist, collapse = "|")
  broad_injury <- gsub(pasted, bodypart, injuries$injury_types)
  str_count(broad_injury, pattern = bodypart)

  }
```



Calculating broad injury counts
```{r}
# Head
head_counts <- broad(Head, "head")

# Shoulder
shoulder_counts <- broad(Shoulder, "shoulder")

# Upper Torso
uppertorso_counts <- broad(UpperTorso, "uppertorso")

# Lower Torso
lowertorso_counts <- broad(LowerTorso, "lowertorso")

# Arm
arm_counts <- broad(Arm, "arm")

# Hand
hand_counts <- broad(Hand, "hand")

# Leg
leg_counts <- broad(Leg, "leg")

# Foot
foot_counts <- broad(Foot, "foot")
```




Adding body part columns to the orginal injury data frame
```{r}
injuries <- injuries %>% 
  mutate(head = head_counts) %>%
  mutate(shoulder = shoulder_counts) %>%
  mutate(upper_torso = uppertorso_counts) %>%
  mutate(lower_torso = lowertorso_counts) %>%
  mutate(arm = arm_counts) %>%
  mutate(hand = hand_counts) %>%
  mutate(leg = leg_counts) %>%
  mutate(foot = foot_counts)
  

head(injuries)
```


Save the cleaned data frame
```{r}
write.csv(injuries,"C:/Users/wduff/OneDrive/School/Harvard/Fall2021/BST260/BST_260_project/cleaneddata.csv", row.names = TRUE)
```





Gathering into long format
```{r}
injury_gather <- gather(injuries, key = "bodypart", value = "counts", 28:ncol(injuries))
injury_gather
```



Overall distribution of body part injuries
```{r}
injury_gather %>% 
  group_by(bodypart) %>%
  summarise(counts = sum(counts)) %>%
  ggplot(aes(x = reorder(bodypart, -counts), y = counts)) +
  geom_col() +
  xlab("Body Part") +
  ylab("Count") +
  ggtitle("Distriubtion of Injuries by Body Part")
```



Now for the next part at EDA, let's look at the injury distributions across the various positions in football
```{r}
levels(as.factor(injuries$position_id))
```

```{r}
injuries %>% filter(position_id == "K")
```



We see we have the following positions: Kicker (K), Offensive Line (OL), Punter (P), Quarter Back (QB), Running Back (RB), Tight End (TE), Wide Reciever (WR) and Defense (DEF).

Since Defense has it's own category with no specific position (like Linebacker, Defensive Line or Safety), let's first compare the injury distributions between Offensive Players and Defensive Players

```{r}
offensive_position <- c("K", "OL", "P", "QB", "RB", "TE", "WR")

offense <- injury_gather %>% filter(position_id %in% offensive_position)
defense <- injury_gather %>% filter(position_id == "DEF") 

levels(as.factor(offense$position_id))
levels(as.factor(defense$position_id))

dim(offense)
dim(defense)
```

We have 7712 offensive players and 72309 defensive players which is great since the data sets are somewhat balanced and therefore comparing them will be valid. 




Overall distribution of offensive injuries
```{r}
offense %>% 
  group_by(bodypart) %>%
  summarise(counts = sum(counts)) %>%
  ggplot(aes(x = reorder(bodypart, -counts), y = counts)) +
  geom_col() +
  xlab("Body Part") +
  ylab("Count") +
  ggtitle("Distriubtion of Offensive Injuries")
```



Overall distribution of defensive injuries
```{r}
defense %>% 
  group_by(bodypart) %>%
  summarise(counts = sum(counts)) %>%
  ggplot(aes(x = reorder(bodypart, -counts), y = counts)) +
  geom_col() +
  xlab("Body Part") +
  ylab("Count") +
  ggtitle("Distriubtion of Defensive Injuries")
```



Distribution of injuries for kickers
```{r}
offense %>% 
  filter(position_id == "K") %>%
  group_by(bodypart) %>%
  summarise(counts = sum(counts)) %>%
  ggplot(aes(x = reorder(bodypart, -counts), y = counts)) +
  geom_col() +
  xlab("Body Part") +
  ylab("Count") +
  ggtitle("Distriubtion of Offensive Injuries")
```









```{r}
injury_gather %>% 
  group_by(team) %>%
  summarise(counts = sum(counts)) %>%
  ggplot(aes(x = reorder(team, -counts), y = counts)) +
  geom_col() +
  xlab("NFL Team") +
  ylab("Count") +
  ggtitle("Distriubtion of Injuries by Team")
```

```{r}
injury_gather %>% 
  group_by(year) %>%
  summarise(counts = sum(counts)) %>%
  ggplot(aes(x = year, y = counts)) +
  geom_col() +
  xlab("Year") +
  ylab("Count") +
  ggtitle("Distriubtion of Injuries by Year")
```


```{r}
injury_gather %>% 
  group_by(height_inches) %>%
  summarise(counts = sum(counts)) %>%
  ggplot(aes(x = height_inches, y = counts)) +
  geom_col() +
  xlab("Height (in)") +
  ylab("Count") +
  ggtitle("Distriubtion of Injuries by Height")

injury_gather %>% 
  group_by(weight_pounds) %>%
  summarise(counts = sum(counts)) %>%
  ggplot(aes(x = weight_pounds, y = counts)) +
  geom_col() +
  xlab("Weight (lbs)") +
  ylab("Count") +
  ggtitle("Distriubtion of Injuries by Weight")
```


```{r}
injury_age <- injury_gather %>% mutate(age = floor(as.numeric(difftime(Sys.Date(),injury_gather$birthdate, units = "weeks"))/52.25))

injury_age
```



```{r}
injury_age %>% 
  group_by(age) %>%
  summarise(counts = sum(counts)) %>%
  ggplot(aes(x = age, y = counts)) +
  geom_col() +
  xlab("Age") +
  ylab("Count") +
  ggtitle("Distriubtion of Injuries by Age")
```


```{r}
injury_age %>% 
  group_by(bodypart) %>%
  filter(age == 37) %>%
  summarise(counts = sum(counts)) %>%
  ggplot(aes(x = reorder(bodypart, - counts), y = counts)) +
  geom_col() +
  theme(
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    title = element_text(size = 18)
    ) +
  xlab("Age = 37 Years") +
  ylab("Count") +
  ggtitle("Distriubtion of Injuries 37 Year Old NFL players")
```


```{r}
new <- injury_age %>% select(age)
range(new %>% drop_na())

which(new$age == 75)
new[1238,]

which(injury_age$age == 75)



#This guy is actually born in 1979 - same name as a guy born in 1945
injury_age[1238,]

#same guy
injury_age[18600, ]

injury_age[35962, ]

injury_age[53324, ]
injury_age[70686, ]

injury_age[88048, ]
injury_age[105410, ]
injury_age[122772, ]

#For every time D.D. Lewis 'name' observation, we need to change the 'birthdate' to 1979-01-08

#temp <- injury_age %>% ifelse(name == "D.D. Lewis", birthdate == "1979-01-08", )

```


Shiny App:
Drop down menu --> all players, offensive players, defensive players, ???team???
Numeric scale of age --> Give distribution based on age
Another drop down menu? --> just specific offensive positions
Time varying counts? --> injury counts based on year




```{r}
eval(parse(text = str_to_lower("Offense"))) %>%
                group_by(bodypart) %>%
                summarise(counts = sum(counts)) %>%
                ggplot(aes(x = reorder(bodypart, - counts), y = counts)) +
                geom_col() +
                theme(
                    axis.title.x = element_text(size = 15),
                    axis.title.y = element_text(size = 15),
                    title = element_text(size = 22),
                    plot.title = element_text(hjust = 0.5)
                ) +
                xlab("Injuries") +
                ylab("Count") +
                ggtitle("Distriubtion of Injuries for NFL players")
```


