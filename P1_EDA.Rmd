---
title: "EDA for P1"
author: "k-Nearest Tailgaters"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = TRUE, message = F)
```


```{r, include=F}
library(AER)
library(caret)
library(e1071)
library(foreign)
library(gam)
library(ggrepel)
library(ggthemes)
library(gridExtra)
library(magrittr)
library(nnet)
library(pander)
library(pROC)
library(pscl)
library(randomForest)
library(rpart)
library(splines)
library(splines2)
library(splitstackshape)
library(tidyverse)
library(VGAM)
library(vcd)
options(digits = 3)
theme_update(plot.title = element_text(hjust = 0.5))
```

```{r}
injuries = read.csv("injuries_players2021-11-15.csv") # load data
```

```{r, include=F}
fix_nfl_names <- function(x){ #https://rdrr.io/github/papagorgio23/bettoR/src/R/fix_nfl_names.R
  x[grep("Arizona Cardinals", x, ignore.case=TRUE)] <- "ARI"
  
  x[grep("Atlanta Falcons", x, ignore.case=TRUE)] <- "ATL"

  x[grep("Baltimore Ravens", x, ignore.case=TRUE)] <- "BAL"

  x[grep("Buffalo Bills", x, ignore.case=TRUE)] <- "BUF"

  x[grep("Carolina Panthers", x, ignore.case=TRUE)] <- "CAR"

  x[grep("Chicago Bears", x, ignore.case=TRUE)] <- "CHI"

  x[grep("Cincinnati Bengals", x, ignore.case=TRUE)] <- "CIN"

  x[grep("Cleveland Browns", x, ignore.case=TRUE)] <- "CLE"

  x[grep("Dallas Cowboys", x, ignore.case=TRUE)] <- "DAL"

  x[grep("Denver Broncos", x, ignore.case=TRUE)] <- "DEN"

  x[grep("Detroit Lions", x, ignore.case=TRUE)] <- "DET"

  x[grep("Green Bay Packers", x, ignore.case=TRUE)] <- "GB"

  x[grep("Houston Texans", x, ignore.case=TRUE)] <- "HOU"

  x[grep("Indianapolis Colts", x, ignore.case=TRUE)] <- "IND"

  x[grep("Jacksonville Jaguars", x, ignore.case=TRUE)] <- "JAX"

  x[grep("Kansas City Chiefs", x, ignore.case=TRUE)] <- "KC"

  x[grep("Miami Dolphins", x, ignore.case=TRUE)] <- "MIA"

  x[grep("Minnesota Vikings", x, ignore.case=TRUE)] <- "MIN"

  x[grep("New England Patriots", x, ignore.case=TRUE)] <- "NE"

  x[grep("New Orleans Saints", x, ignore.case=TRUE)] <- "NO"

  x[grep("New York Jets", x, ignore.case=TRUE)] <- "NYJ"

  x[grep("New York Giants", x, ignore.case=TRUE)] <- "NYG"

  x[grep("Las Vegas Raiders", x, ignore.case=TRUE)] <- "OAK"

  x[grep("Philadelphia Eagles", x, ignore.case=TRUE)] <- "PHI"

  x[grep("Pittsburgh Steelers", x, ignore.case=TRUE)] <- "PIT"

  x[grep("Los Angeles Chargers", x, ignore.case=TRUE)] <- "LAC"

  x[grep("Los Angeles Rams", x, ignore.case=TRUE)] <- "LAR"

  x[grep("San Francisco 49ers", x, ignore.case=TRUE)] <- "SF"

  x[grep("Seattle Seahawks", x, ignore.case=TRUE)] <- "SEA"

  x[grep("Tampa Bay Buccaneers", x, ignore.case=TRUE)] <- "TB"

  x[grep("Tennessee Titans", x, ignore.case=TRUE)] <- "TEN"

  x[grep("Washington Redskins", x, ignore.case=TRUE)] <- "WAS"

  return(x)
}
```


```{r}
injuries = injuries %>% mutate(short_team_name = fix_nfl_names(full_team)) %>% 
                        select(name, full_team, 
                               year, games_in_season, 
                               num_games_missing, num_games_injured, injury_types,
                               earliest_injury, latest_injury, position_id, 
                               height_inches, weight_pounds, birthdate,
                               short_team_name) %>% 
                        filter(position_id != "")
```

&nbsp;

# P1

### Which positions are most at-risk for injuries? We’ll compile basic descriptive statistics on this question'

```{r}
number_injury = injuries %>% group_by(position_id, year) %>% 
                             count()
                        
number_injury %>% ggplot(aes(year, n, color = position_id)) +
                    geom_line() +
                    ylab("# of Injuries") +
                    scale_color_discrete(name = "Position")


```

&nbsp;

### We’ll run logistic regression and other classification models (kNN, random forest, etc.). We will regress the binary variable `injury` on the categorical covariate `position_id`.

&nbsp;

```{r}
players = read.csv("all_players_some_injuries2021-11-16.csv")

players = players %>% 
            mutate(injury = as.factor(ifelse(is.na(injury_types), 0, 1)), # make binary injury variable
                   position_id = as.factor(position_id),
                   bmi = weight_pounds / height_inches^2)


# Missing data
apply(players %>% 
        select(injury, bmi, height_inches, weight_pounds, position_id), 2, 
      function(x) sum(is.na(x))) %>% pander

# remove missing values in height/weight/bmi
players = players %>% filter(!is.na(height_inches), !is.na(weight_pounds))
```

&nbsp;

### Logistic regression (model only; check for significant coefficients)

```{r}
logi_fit = glm(data = players, injury ~ position_id + bmi, family = binomial())
pander(summary(logi_fit))

```

&nbsp;

# Machine Learning and Prediction

&nbsp;

## Create training and test set

```{r}
set.seed(1)

x <- stratified(players, "injury", 0.7, keep.rownames = TRUE)
train_set <- x %>% dplyr::select(-rn)
train_index <- as.numeric(x$rn)
test_set <- players[-train_index,]

dim(train_set)
dim(test_set)
```

&nbsp;

### Logistic regression

```{r, logistic regression}
logi_fit = glm(data = train_set, injury ~ position_id + bmi, family = binomial())

p_hat_logit = predict(logi_fit, newdata = test_set, type = "response") # get predicted probabilities

y_hat_logit <- as.factor(ifelse(p_hat_logit > 0.5, 1, 0)) # set threshold of 0.5

confusionMatrix(data = y_hat_logit, 
                reference = test_set[["injury"]], positive = "1") # generate confusion matrix

```


&nbsp;

### k-Nearest Neighbors

```{r kNN}
# TODO get 'k' through cross-validation
#k_cv = 

knn_fit = knn3(data = train_set, injury ~ position_id + bmi, k = 11) # fit kNN

f_hat_knn = predict(knn_fit, newdata = test_set)[ , 2] # get probability for death (outcome = 1)

y_hat_knn = as.factor(ifelse(f_hat_knn > 0.5, 1, 0))

confusionMatrix(data = y_hat_knn, 
                reference = test_set[["injury"]], positive = "1") # generate confusion matrix

```


&nbsp;

### Random Forest

```{r Random Forest}
rf_fit = randomForest(injury ~ position_id + bmi, 
                      data = players[train_index, ]) # fit random forest using training set
           
p_hat_rf = predict(rf_fit, newdata = test_set, type = "prob")[,2] # get predicted probabilities

y_hat_rf = as.factor(ifelse(p_hat_rf > 0.5, 1, 0)) # use 0.5 cutoff to get estimates

confusionMatrix(data = y_hat_rf, 
                reference = test_set[["injury"]], positive = "1") # generate confusion matrix

```


